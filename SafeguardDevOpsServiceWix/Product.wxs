<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <Product Id="*" Name="SafeguardDevOpsService" Language="1033" Version="1.0.0.0" Manufacturer="!(loc.CompanyName)" UpgradeCode="8a0194a6-6aed-441c-8130-a81b96490bd7">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes"  />

    <Icon Id="safeguard.ico" SourceFile="$(var.ProjectDir)\..\SafeguardLogo.ico"/>

    <Property Id="ARPPRODUCTICON">safeguard.icon</Property>
    <Property Id="ARPURLINFOABOUT">https://github.com/OneIdentity/SafeguardDevOpsService</Property>
    <Property Id="MSIUSEREALADMINDETECTION" Value="1" />

    <Condition Message="Installation requires Administrator privileges">
      <![CDATA[Privileged]]>
    </Condition>

    <UIRef Id="WixUI_Minimal" />
    <WixVariable Id="WixUIBannerBmp" Value="$(var.ProjectDir)\install-banner.bmp"/>
    <WixVariable Id="WixUIDialogBmp" Value="$(var.ProjectDir)\install-panel.bmp"/>
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\..\LICENSE.rtf"/>

    <Feature Id="ProductFeature" Title="SafeguardDevOpsService" Level="1">
			<ComponentGroupRef Id="DevOps_CommonAssemblies" />
		</Feature>

    <CustomAction Id="EXECUTE_INSTALL"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check"
                  FileKey="SafeguardDevOpsService.exe"
                  ExeCommand="install" />
    <CustomAction Id="EXECUTE_START"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check"
                  FileKey="SafeguardDevOpsService.exe"
                  ExeCommand="start" />
    <CustomAction Id="EXECUTE_STOP"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check"
                  FileKey="SafeguardDevOpsService.exe"
                  ExeCommand="stop" />
    <CustomAction Id="EXECUTE_UNINSTALL"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check"
                  FileKey="SafeguardDevOpsService.exe"
                  ExeCommand="uninstall" />
    <Property Id="ExecuteCommand">cmd.exe</Property>
    <CustomAction Id="CLEANUP_DATA_ON_UNINSTALL"
                  Property="ExecuteCommand"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore"
                  ExeCommand='/c rmdir "[AppDataFolder]!(loc.ProductNameFolder)" /s /q' />
    <CustomAction Id="CLEANUP_EXT_DATA_ON_UNINSTALL"
                  Property="ExecuteCommand"
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore"
                  ExeCommand='/c rmdir "\!(loc.ProductNameFolder)" /s /q' />

    <InstallExecuteSequence>
      <Custom Action="EXECUTE_STOP" After="CostFinalize">Installed</Custom>
      <Custom Action="EXECUTE_UNINSTALL" After="EXECUTE_STOP">Installed</Custom>
      <Custom Action="CLEANUP_DATA_ON_UNINSTALL" After="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="CLEANUP_EXT_DATA_ON_UNINSTALL" After="CLEANUP_DATA_ON_UNINSTALL">REMOVE="ALL"</Custom>
      <Custom Action="EXECUTE_INSTALL" After="InstallFinalize">NOT Installed</Custom>
      <Custom Action="EXECUTE_START" After="EXECUTE_INSTALL">NOT Installed</Custom>
    </InstallExecuteSequence>


  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLLOCATION" Name="!(loc.ProductNameFolder)" />
      </Directory>
    </Directory>
  </Fragment>

</Wix>
